name: Build XD75 Firmware (Latest QMK + Auto Release + ASCII Table)
on:
  push:
    branches: [ main, master ]
  pull_request:
    paths:
      - "keyboards/**/keymaps/**/keymap.c"
      - "keyboards/**/keymaps/**/**.h"
      - ".github/workflows/qmk-build.yml"
jobs:
  build:
    runs-on: ubuntu-latest
    name: Build QMK Keymap + JSON

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install QMK dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip gcc-avr binutils-avr avr-libc dfu-programmer dfu-util

      - name: Install QMK
        run: |
          pip3 install qmk

      - name: Setup QMK
        run: |
          qmk setup -y .

      - name: Build firmware
        run: |
          qmk compile -kb <keyboard> -km <keymap>

      - name: Generate keymap JSON
        run: |
          qmk c2json --no-ccp \
            -kb <keyboard> \
            -km <keymap> \
            -o <keyboard>_<keymap>.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qmk-build
          path: |
            *.hex
            *.bin
            *.json


      - name: Create version tag
        continue-on-error: true
        run: |
          DATE_TAG=$(date +'%Y.%m.%d')
          COUNT=$(git tag -l "v${DATE_TAG}*" | wc -l)
          TAG="v${DATE_TAG}-$((COUNT+1))"
          echo "TAG=$TAG" >> $GITHUB_ENV
          git tag $TAG
          git push origin $TAG
