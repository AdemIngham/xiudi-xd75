name: Build QMK Keymap + JSON

on:
  push:
    paths:
      - "keyboards/**/keymaps/**/keymap.c"
      - "keyboards/**/keymaps/**/**.h"
      - ".github/workflows/qmk-build.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install QMK dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip gcc-avr binutils-avr avr-libc dfu-programmer dfu-util

      - name: Install QMK
        run: |
          pip3 install qmk

      - name: Configure QMK environment
        run: |
          export QMK_HOME="$GITHUB_WORKSPACE"
          qmk config user.qmk_home="$QMK_HOME"

      - name: Build firmware
        run: |
          qmk compile -kb <keyboard> -km <keymap>

      - name: Generate keymap JSON
        run: |
          qmk c2json --no-ccp \
            -kb <keyboard> \
            -km <keymap> \
            -o <keyboard>_<keymap>.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qmk-build
          path: |
            *.hex
            *.bin
            *.json
